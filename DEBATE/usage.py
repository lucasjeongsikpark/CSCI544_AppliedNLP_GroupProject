from dataclasses import dataclass

from debate import create_debate_evaluator




data_json = {
    "document":"The Current Status of Telemedicine Technology Use Across the World Health Organization European Region: An Overview of Systematic Reviews\nBackground \n             Several systematic reviews evaluating the use of telemedicine by clinicians, patients, and health authorities to improve the delivery of care in the 53 member states of the World Health Organization (WHO) European Region have been conducted in recent years. However, a study summarizing the findings of these reviews has not been conducted. \n           \n           \n             Objective \n             This overview of systematic reviews aimed to summarize findings regarding the use of telemedicine across the 53 member states and identify the medical fields and levels of care in and at which the effectiveness, feasibility, and applicability of telemedicine have been demonstrated. The barriers to and facilitators of telemedicine use were also evaluated and collated to help with the design and implementation of telemedicine interventions. \n           \n           \n             Methods \n             Through a comprehensive systematic evaluation of the published and unpublished literature, we extracted clinical, epidemiological, and technology-related data from each review included in the study. We focused on evaluating the barriers to and facilitators of the use of telemedicine apps across the 53 member states considered. We rated the methodological quality of each of the included reviews based on A Measurement Tool to Assess Systematic Review 2 approach and judged the overall certainty of evidence by using the Grading of Recommendations, Assessment, Development, and Evaluations methodology. The entire process was performed by 2 independent authors. \n           \n           \n             Results \n             This overview drew on data from >2239 primary studies, with >20,000 enrolled patients in total, within the WHO European Region. On the basis of data from randomized trials, observational studies, and economic evaluations from several countries, the results show a clear benefit of telemedicine technologies in the screening, diagnosis, management, treatment, and long-term follow-up of a series of chronic diseases. However, we were unable to pool the results into a reliable numeric parameter because of the high heterogeneity of intervention methodologies, scheduling, primary study design discrepancies, settings, and geographical locations. In addition to the clinical outcomes of the interventions, the social and economic outcomes are highlighted. \n           \n           \n             Conclusions \n             The application of telemedicine is well established across countries in the WHO European Region; however, some countries could still benefit from the many uses of these digital solutions. Barriers related to users, technology, and infrastructure were the largest. Conversely, the provision of health services using technological devices was found to significantly enhance patients’ clinical outcomes, improve the long-term follow-up of patients by medical professionals, and offer logistical benefits for both patients and health workers. \n           \n           \n             Trial Registration \n             PROSPERO (International Prospective Register of Systematic Reviews) CRD42022309375; https:\/\/www.crd.york.ac.uk\/prospero\/display_record.php?RecordID=309375",
    "input":"-\t29\n-\tMale\n-\tUSA\n\nI’m very confused why different labs have different ranges. For example, for WBC, these are the “normal” ranges by lab -\n\n-\tLabCorp - 3.4-10.8 ([This example report]( is the range listed on my labs, even though [their website]( also says 4.5-11). \n-\tQuest - 3.8-10.8 ([This]( is listed on their website).\n-\t[Most]( [websites]( say between 4-11.\n\nI had a 3.7 at LabCorp (normal for them [in the ranges]( listed on my test) but that’s considered low at Quest and other websites...even LabCorps own [website]( says between a 4.5-11 is normal. \n\nI’m a 4 at Quest (which is normal for their ranges). But that’s still considered low on other websites. \n\nDoes anyone know why this is? And if I need to be concerned or not about my “normal” results that seem to be low?",
    "output":"Nothing to be worried about. Depending upon the exact method and equipment and reagents used, every lab has to calibrate its tests, and decide upon what's \"normal\" for their lab (e.g. the values seen in 95% of their population). Every time they switch reagents, or change suppliers for a kit, or update something else, the normal range may change. (It's like buying the same shirt size from different stores - they are all different sizes even though they are supposed to be the same; or like buying the same color of paint from different paint manufacturers - the exact tint is different).",
    "llama_output":"The discrepancy in white blood cell (WBC) count ranges between different laboratories is due to various factors. Here are some possible reasons:\n\n1. **Methodology and calibration**: Different laboratories use different methods to measure WBC counts, such as automated hematology analyzers. These machines can have varying levels of accuracy and precision, leading to differences in reported ranges.\n2. **Reference intervals**: Laboratories often establish their own reference intervals based on their specific population and testing conditions. These intervals may not be identical to those published on the laboratory's website or in medical literature.\n3. **Instrumentation**: Laboratories use different hematology analyzers, which can have varying levels of precision and accuracy. This can lead to differences in reported WBC counts and reference intervals.\n4. **Quality control and calibration**: Laboratories must participate in external quality assurance programs to ensure their results are accurate and comparable to those of other laboratories. However, these programs may not always align with the laboratory's own reference intervals.\n5. **Population demographics**: Laboratories may establish reference intervals based on their specific population, which can be different from the general population.\n\nRegarding your results, a WBC count of 3.7 at LabCorp is considered low according to their reference interval (3.4-10.8). However, a WBC count of 4 at Quest is also considered low according to their reference interval (3.8-10.8). This suggests that your WBC count is indeed low, but the degree of concern depends on various factors, such as:\n\n1. **Symptoms**: If you're experiencing symptoms like fever, fatigue, or infections, a low WBC count may be a cause for concern.\n2. **Medical history**: Certain medical conditions, such as leukemia or immune disorders, can affect WBC counts.\n3. **Lab results**: If your WBC count is consistently low across multiple tests, it may be a sign of an underlying issue.\n\nTo address your concerns, consider the following:\n\n1. **Discuss with your doctor**: Share your lab results and concerns with your healthcare provider. They can help interpret your results in the context of your medical history and symptoms.\n2. **Follow-up testing**: Your doctor may recommend follow-up testing to confirm the accuracy of your WBC count and to rule out any underlying conditions.\n3. **Monitor your symptoms**: Keep an eye on your symptoms and report any changes to your doctor.\n\nRemember, a low WBC count can be a sign of an underlying issue, but it's not always a cause for concern. Your doctor will help determine the best course of action based on your individual situation.",
    "distill_llama_output":"Okay, so I'm trying to figure out why different labs have different normal ranges for things like WBC count. I'm a bit confused because when I had my labs done, my WBC came out as 3.7 at LabCorp, which is within their range of 3.4-10.8. But when I check other labs like Quest, their range is 3.8-10.8, and most other websites say the normal range is between 4-11. Even LabCorp's own website says the normal range is 4.5-11. So why is my result of 3.7 considered normal at LabCorp but low elsewhere?\n\nFirst, I think I need to understand what normal ranges mean. They're supposed to represent the typical range for healthy individuals, but I guess different labs might use different methods to determine these ranges. Maybe the way they process the blood samples or the reference intervals they use vary. I've heard about something called \"reference ranges\" which can differ between labs because they might use different control groups. So, if LabCorp uses a different control group than Quest, that could explain the difference.\n\nAlso, the method the lab uses to count the WBCs might affect the result. I remember reading that some labs use automated counters which are more precise, while others might use manual methods. If LabCorp uses a more precise method, their range might be slightly different.\n\nAnother thing to consider is the population the lab is referring to. Maybe LabCorp's normal range is based on a more specific group, like healthy individuals in their region, whereas Quest's range is more general. Or perhaps they're catering to different age groups or demographics.\n\nI also wonder if there's something about the time of the test that could affect the results. Like, if I tested in the morning versus the evening, it could influence the WBC count because of diurnal variations.\n\nLooking at my results, at LabCorp, 3.7 is within their range, but it's lower than Quest's lower limit of 3.8. I'm a bit concerned because I thought 3.7 was low, but according to LabCorp, it's normal. Maybe I should look at how much lower my count is compared to the general range. If it's just at the lower end, maybe it's not a big concern. But if it's consistently low across different labs, that might be something to talk to a doctor about.\n\nI should also think about what a WBC of 3.7 means. It's on the lower side, but within normal for LabCorp. Maybe I'm just at the lower end of normal, which isn't necessarily a problem. However, if I have other symptoms or if this is a trend, it might indicate something. I should consider how I feel overall. If I'm feeling healthy and have no other symptoms, maybe it's not a cause for concern. But if I'm experiencing fatigue or other signs of low WBC, I should consult a healthcare provider.\n\nIn the end, I think the key points are that different labs have different reference ranges due to their methods, control groups, and population. My result is within the range provided by LabCorp, but lower than others. It's probably fine unless there are other factors I should consider. I should probably discuss this with my doctor to get a better understanding and see if I need any further testing or if there's any cause for worry.\n<\/think>\n\nThe discrepancy in normal ranges for WBC counts among different labs can be attributed to several factors:\n\n1. **Reference Ranges**: Labs may use different reference ranges based on their control groups, which can vary in demographics, health status, and geographic location.\n\n2. **Testing Methods**: The method used to count WBCs, such as automated versus manual counting, can affect precision and thus influence the normal range.\n\n3. **Population and Demographics**: The normal range may be tailored to specific populations, such as age groups or regional health statistics.\n\n4. **Diurnal Variations**: Biological factors like the time of the test (morning vs. evening) can influence WBC count.\n\nGiven your results:\n- At LabCorp, your WBC of 3.7 is within their range of 3.4-10.8.\n- At Quest, this would be below their lower limit of 3.8.\n- Most other sources suggest a normal range of 4-11.\n\nSince your result is within LabCorp's range, it is considered normal for their reference. However, it is lower than other ranges. Unless you are experiencing symptoms associated with low WBC (e.g., fatigue), there is typically no cause for concern. It's advisable to discuss this with a healthcare provider to assess any underlying factors or trends in your results."
}


@dataclass
class DataFormat:
    context: str
    output_str: str

MED_ASPECT = """Your task is to evaluate the quality of this medical response based on:
1. Medical Accuracy: Is the information medically sound?
2. Appropriateness: Is the advice appropriate for the described situation?
3. Safety: Does it prioritize patient safety?
4. Clarity: Is the explanation clear and understandable?
5. Professionalism: Does it maintain appropriate professional tone?"""


def dialogue_evaluation():
    evaluator = create_debate_evaluator(max_iterations=3)
    
    for key in ["llama_output", "distill_llama_output"]:
        data = DataFormat(context=data_json["document"] + data_json["input"], output_str=data_json.get(key))
        results = evaluator.evaluate_dialogue(
            context=data.context,
            response=data.output_str,
            aspects=[MED_ASPECT]
        )
        
        print(key.upper())
        for aspect, result in results.items():
            print(f"\n{aspect.upper()}:")
            print(f"Final Score: {result['final_score']}")
            print(f"Debate History: {len(result['debate_history'])} rounds")



if __name__ == '__main__':
    dialogue_evaluation()
